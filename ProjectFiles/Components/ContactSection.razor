@using MyShowCase.Data
@using MyShowCase.Data.ContactSectionModels
@using MyShowCase.Data.EF
@using MyShowCase.Data.EF.Entities
@using Microsoft.EntityFrameworkCore

<section id="contact" class="contact section light-background">
    <div class="container section-title">
        <h2>@Model.SectionTitle</h2>
        <p>@Model.SectionSubtitle</p>
    </div>

    <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4 g-lg-5">

            <!-- Left: Contact Info -->
            <div class="col-lg-5">
                <div class="info-box">
                    <h3>@Model.Info.Title</h3>
                    <p>@Model.Info.Description</p>

                    @foreach (var item in Model.Info.Items)
                    {
                        <div class="info-item">
                            <div class="icon-box"><i class="@item.Icon"></i></div>
                            <div class="content">
                                <h4>@item.Title</h4>
                                @foreach (var line in item.Lines)
                                {
                                    <p>@line</p>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Right: Contact Form -->
            <div class="col-lg-7">
                <div class="contact-form">
                    <h3>@Model.Form.Title</h3>
                    <p>@Model.Form.Description</p>

                    <EditForm Model="formModel" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        <div class="row gy-4">
                            <div class="col-md-6">
                                <InputText class="form-control" @bind-Value="formModel.Name" placeholder="Your Name" />
                            </div>
                            <div class="col-md-6">
                                <InputText type="email" class="form-control" @bind-Value="formModel.Email" placeholder="Your Email" />
                            </div>
                            <div class="col-12">
                                <InputText class="form-control" @bind-Value="formModel.Subject" placeholder="Subject" />
                            </div>
                            <div class="col-12">
                                <InputTextArea class="form-control" @bind-Value="formModel.Message" placeholder="Message" rows="6" />
                            </div>

                            <div class="col-12 text-center">
                                @if (isSubmitting)
                                {
                                    <div class="loading">Saving...</div>
                                }
                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="error-message">@errorMessage</div>
                                }
                                @if (isSuccess)
                                {
                                    <div class="sent-message">Your message has been saved. Thank you!</div>
                                }
                                <button type="submit" class="btn" disabled="@isSubmitting">@Model.Form.SubmitButtonText</button>
                            </div>
                        </div>
                    </EditForm>

                    <div class="mt-4">
                        <h4>Recent Messages</h4>
                        @if (recentMessages.Count == 0)
                        {
                            <p class="text-muted">No messages yet.</p>
                        }
                        else
                        {
                            <ul class="list-group">
                                @foreach (var m in recentMessages)
                                {
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between">
                                            <strong>@m.Name</strong>
                                            <span class="text-muted" style="font-size: 0.9rem">@m.CreatedUtc.ToLocalTime()</span>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.95rem">@m.Email — @m.Subject</div>
                                        <div>@m.Message</div>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

@code {
    private ContactSectionModel Model { get; set; }

    private ContactFormModel formModel = new();
    private bool isSubmitting = false;
    private bool isSuccess = false;
    private string? errorMessage;
    private List<ContactMessage> recentMessages = new();

    [Inject] private IDbContextFactory<AppDbContext> DbFactory { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Model = GetContactSection();
        await LoadRecentAsync();
    }

    private ContactSectionModel GetContactSection()
    {
        return new ContactSectionModel
        {
            SectionTitle = "Contact",
            SectionSubtitle = "Have a project in mind? Let’s talk about timelines, scope, and fit.",
            Info = new ContactInfo
            {
                Title = "Contact Info",
                Description = "Reach me via email or phone, or drop a message using the form. I usually reply within one business day.",
                Items = new List<ContactInfoItem>
                {
                    new ContactInfoItem
                    {
                        Icon = "bi bi-geo-alt",
                        Title = "Our Location",
                        Lines = new() { "A108 Adam Street", "New York, NY 535022" }
                    },
                    new ContactInfoItem
                    {
                        Icon = "bi bi-telephone",
                        Title = "Phone Number",
                        Lines = new() { "+1 5589 55488 55", "+1 6678 254445 41" }
                    },
                    new ContactInfoItem
                    {
                        Icon = "bi bi-envelope",
                        Title = "Email Address",
                        Lines = new() { "info@example.com", "contact@example.com" }
                    }
                }
            },
            Form = new ContactForm
            {
                Title = "Get In Touch",
                Description = "Tell me a bit about your goals and how I can help.",
                Fields = new()
                {
                    new FormField { Name = "name", Type = "text", Placeholder = "Your Name", IsRequired = true },
                    new FormField { Name = "email", Type = "email", Placeholder = "Your Email", IsRequired = true },
                    new FormField { Name = "subject", Type = "text", Placeholder = "Subject", IsRequired = true },
                    new FormField { Name = "message", Type = "textarea", Placeholder = "Message", IsRequired = true, Rows = 6 }
                },
                SubmitButtonText = "Send Message",
                Action = "forms/contact.php",
                Method = "post"
            }
        };
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        isSuccess = false;
        errorMessage = null;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var entity = new ContactMessage
            {
                Name = formModel.Name.Trim(),
                Email = formModel.Email.Trim(),
                Subject = string.IsNullOrWhiteSpace(formModel.Subject) ? null : formModel.Subject.Trim(),
                Message = formModel.Message.Trim(),
                CreatedUtc = DateTime.UtcNow
            };
            db.ContactMessages.Add(entity);
            await db.SaveChangesAsync();
            isSuccess = true;
            formModel = new();
            await LoadRecentAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task LoadRecentAsync()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            recentMessages = await db.ContactMessages
                .OrderByDescending(x => x.CreatedUtc)
                .Take(5)
                .ToListAsync();
        }
        catch
        {
            // ignore initial load errors (e.g., first-run before DB init)
        }
    }

    private class ContactFormModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.StringLength(200)]
        public string Name { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.StringLength(200)]
        public string? Subject { get; set; }

        [System.ComponentModel.DataAnnotations.Required]
        public string Message { get; set; } = string.Empty;
    }
}
